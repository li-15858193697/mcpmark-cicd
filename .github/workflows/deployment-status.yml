name: Deployment Status

on:
  push:
    branches:
      - main

jobs:
  pre-deployment:
    name: pre-deployment
    runs-on: ubuntu-latest
    outputs:
      issue-number: ${{ steps.create-issue.outputs.issue-number }}
      previous-sha: ${{ steps.get-commits.outputs.previous-sha }}
      current-sha: ${{ steps.get-commits.outputs.current-sha }}
      package-version: ${{ steps.get-version.outputs.version }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run lint checks
        run: npm run lint || echo "Lint not configured, skipping"
        continue-on-error: true
      
      - name: Run tests
        run: npm test || echo "Tests not configured, skipping"
        continue-on-error: true
      
      - name: Get commit information
        id: get-commits
        run: |
          CURRENT_SHA="${{ github.sha }}"
          PREVIOUS_SHA=$(git rev-parse HEAD~1 2>/dev/null || echo "none")
          echo "current-sha=${CURRENT_SHA}" >> $GITHUB_OUTPUT
          echo "previous-sha=${PREVIOUS_SHA}" >> $GITHUB_OUTPUT
      
      - name: Get package version
        id: get-version
        run: |
          VERSION=$(node -p "require('./package.json').version" 2>/dev/null || echo "unknown")
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
      
      - name: Create deployment tracking issue
        id: create-issue
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Deployment Tracking - ${context.sha.substring(0, 7)}`,
              body: `## Deployment Started\n\n**Commit:** ${context.sha}\n**Branch:** ${context.ref}\n**Triggered by:** ${context.actor}\n**Workflow Run:** ${context.runId}`,
              labels: ['deployment', 'in-progress']
            });
            core.setOutput('issue-number', issue.data.number);
            return issue.data.number;
      
      - name: Post pre-deployment comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.create-issue.outputs.issue-number }},
              body: 'âœ… Pre-deployment checks completed'
            });

  rollback-preparation:
    name: rollback-preparation
    runs-on: ubuntu-latest
    needs: pre-deployment
    outputs:
      artifact-name: ${{ steps.artifact-info.outputs.artifact-name }}
      checksum: ${{ steps.create-checksum.outputs.checksum }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Checkout previous version
        run: |
          git fetch origin
          git checkout ${{ needs.pre-deployment.outputs.previous-sha }} -- package.json package-lock.json 2>/dev/null || echo "No previous version to backup"
          mkdir -p rollback-artifacts/backup
          if [ -f package.json ]; then
            cp package.json rollback-artifacts/backup/package.json.previous || true
          fi
          if [ -f package-lock.json ]; then
            cp package-lock.json rollback-artifacts/backup/package-lock.json.previous || true
          fi
          git checkout ${{ github.sha }}
      
      - name: Create current config backups
        run: |
          mkdir -p rollback-artifacts/backup
          cp package.json rollback-artifacts/backup/package.json.current
          cp package-lock.json rollback-artifacts/backup/package-lock.json.current 2>/dev/null || echo "No package-lock.json found"
          
          # Create environment template
          cat > rollback-artifacts/backup/env.template <<EOF
          # Environment Configuration Template
          # Add your environment variables here
          NODE_ENV=production
          EOF
      
      - name: Create rollback script
        run: |
          mkdir -p rollback-artifacts
          cat > rollback-artifacts/rollback.sh <<'EOF'
          #!/bin/bash
          set -euo pipefail
          
          echo "ðŸ”„ Starting rollback process..."
          
          # Error handler
          error_exit() {
            echo "âŒ Error: $1" >&2
            exit 1
          }
          
          # Check if running in git repository
          if ! git rev-parse --git-dir > /dev/null 2>&1; then
            error_exit "Not in a git repository"
          fi
          
          PREVIOUS_SHA="${{ needs.pre-deployment.outputs.previous-sha }}"
          CURRENT_SHA="${{ needs.pre-deployment.outputs.current-sha }}"
          
          echo "ðŸ“‹ Rollback Information:"
          echo "  From: $CURRENT_SHA"
          echo "  To: $PREVIOUS_SHA"
          
          # Backup current state before rollback
          echo "ðŸ’¾ Creating backup of current state..."
          git stash push -m "Pre-rollback backup $(date +%Y%m%d-%H%M%S)" || true
          
          # Perform rollback
          echo "â®ï¸  Rolling back to previous commit..."
          if [ "$PREVIOUS_SHA" != "none" ]; then
            git checkout "$PREVIOUS_SHA" || error_exit "Failed to checkout previous commit"
            git checkout -b "rollback-$(date +%Y%m%d-%H%M%S)" || error_exit "Failed to create rollback branch"
          else
            error_exit "No previous commit available for rollback"
          fi
          
          # Restore dependencies
          echo "ðŸ“¦ Restoring dependencies..."
          if [ -f package.json ]; then
            npm ci || npm install || error_exit "Failed to install dependencies"
          fi
          
          echo "âœ… Rollback completed successfully!"
          echo "â„¹ï¸  Current branch: $(git branch --show-current)"
          echo "â„¹ï¸  To push this rollback, run: git push origin $(git branch --show-current)"
          EOF
          
          chmod +x rollback-artifacts/rollback.sh
      
      - name: Create dependency verification script
        run: |
          cat > rollback-artifacts/verify-dependencies.sh <<'EOF'
          #!/bin/bash
          set -euo pipefail
          
          echo "ðŸ” Verifying dependencies compatibility..."
          
          if [ ! -f package.json ]; then
            echo "âŒ package.json not found"
            exit 1
          fi
          
          echo "ðŸ“‹ Package Information:"
          node -p "JSON.stringify(require('./package.json').dependencies, null, 2)" || echo "No dependencies found"
          
          echo ""
          echo "ðŸ§ª Running dependency audit..."
          npm audit --production || echo "âš ï¸  Audit found vulnerabilities"
          
          echo ""
          echo "âœ… Dependency verification complete"
          EOF
          
          chmod +x rollback-artifacts/verify-dependencies.sh
      
      - name: Create rollback documentation
        run: |
          cat > rollback-artifacts/ROLLBACK_README.md <<'EOF'
          # Rollback Documentation
          
          ## Overview
          This package contains all necessary artifacts to rollback the deployment.
          
          ## Deployment Information
          - **Previous Commit:** ${{ needs.pre-deployment.outputs.previous-sha }}
          - **Current Commit:** ${{ needs.pre-deployment.outputs.current-sha }}
          - **Package Version:** ${{ needs.pre-deployment.outputs.package-version }}
          - **Deployment Date:** ${{ github.event.head_commit.timestamp }}
          
          ## Contents
          1. `rollback.sh` - Automated rollback script
          2. `verify-dependencies.sh` - Dependency verification script
          3. `backup/` - Configuration file backups
          4. `ROLLBACK_README.md` - This documentation
          
          ## Quick Rollback Steps
          
          ### Method 1: Automated Script (Recommended)
          ```bash
          # Download and extract the rollback package
          # Make the script executable (if not already)
          chmod +x rollback.sh
          
          # Execute rollback
          ./rollback.sh
          ```
          
          ### Method 2: Manual Rollback
          ```bash
          # 1. Checkout previous commit
          git checkout ${{ needs.pre-deployment.outputs.previous-sha }}
          
          # 2. Create rollback branch
          git checkout -b rollback-$(date +%Y%m%d-%H%M%S)
          
          # 3. Restore dependencies
          npm ci
          
          # 4. Verify the rollback
          npm test
          
          # 5. Push rollback (if needed)
          git push origin HEAD
          ```
          
          ## Configuration Restoration
          If you need to restore previous configurations:
          ```bash
          cp backup/package.json.previous package.json
          cp backup/package-lock.json.previous package-lock.json
          npm ci
          ```
          
          ## Verification Steps
          1. Run dependency verification: `./verify-dependencies.sh`
          2. Run tests: `npm test`
          3. Check application health
          4. Verify all services are running
          
          ## Troubleshooting
          - If rollback script fails, try manual rollback method
          - Check git status before and after rollback
          - Ensure you have proper permissions
          - Review error messages carefully
          
          ## Support
          For assistance, refer to the deployment tracking issue or contact the development team.
          EOF
      
      - name: Set artifact name
        id: artifact-info
        run: |
          ARTIFACT_NAME="rollback-package-${{ github.sha }}"
          echo "artifact-name=${ARTIFACT_NAME}" >> $GITHUB_OUTPUT
      
      - name: Create compressed rollback package
        run: |
          cd rollback-artifacts
          tar -czf ../rollback-package.tar.gz .
          cd ..
      
      - name: Create checksum
        id: create-checksum
        run: |
          CHECKSUM=$(sha256sum rollback-package.tar.gz | awk '{print $1}')
          echo "checksum=${CHECKSUM}" >> $GITHUB_OUTPUT
          echo "${CHECKSUM}  rollback-package.tar.gz" > rollback-package.tar.gz.sha256
      
      - name: Upload rollback artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.artifact-info.outputs.artifact-name }}
          path: |
            rollback-package.tar.gz
            rollback-package.tar.gz.sha256
          retention-days: 30
      
      - name: Post rollback plan comment
        uses: actions/github-script@v7
        with:
          script: |
            const previousSha = '${{ needs.pre-deployment.outputs.previous-sha }}';
            const currentSha = '${{ needs.pre-deployment.outputs.current-sha }}';
            const version = '${{ needs.pre-deployment.outputs.package-version }}';
            const artifactName = '${{ steps.artifact-info.outputs.artifact-name }}';
            const checksum = '${{ steps.create-checksum.outputs.checksum }}';
            
            const comment = `## ðŸ”„ Rollback Plan Ready
            
            ### Deployment Information
            - **Previous Commit:** ${previousSha}
            - **Current Commit:** ${currentSha}
            - **Package Version:** ${version}
            - **Artifact:** ${artifactName}
            
            ### Rollback Components Created
            âœ… Executable rollback script with error handling
            âœ… Configuration backups (package.json, package-lock.json)
            âœ… Dependency verification script
            âœ… Comprehensive rollback documentation
            âœ… Compressed rollback package with checksums
            
            ### Artifact Details
            - **SHA256:** ${checksum}
            - **Retention:** 30 days
            - **Rollback script created:** true
            - **Configuration backup:** true
            
            ### Quick Rollback Command
            \`\`\`bash
            # Download artifact from GitHub Actions
            # Extract the package
            tar -xzf rollback-package.tar.gz
            
            # Execute rollback
            chmod +x rollback.sh
            ./rollback.sh
            \`\`\`
            
            ### Manual Rollback
            \`\`\`bash
            git checkout ${previousSha}
            git checkout -b rollback-$(date +%Y%m%d-%H%M%S)
            npm ci
            npm test
            \`\`\`
            
            ---
            ðŸ“¦ Rollback package ready for download from workflow artifacts.`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.pre-deployment.outputs.issue-number }},
              body: comment
            });

  post-deployment:
    name: post-deployment
    runs-on: ubuntu-latest
    needs: [pre-deployment, rollback-preparation]
    if: success()
    
    steps:
      - name: Update issue labels
        uses: actions/github-script@v7
        with:
          script: |
            // Remove in-progress label
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: ${{ needs.pre-deployment.outputs.issue-number }},
                name: 'in-progress'
              });
            } catch (error) {
              console.log('Label in-progress might not exist:', error.message);
            }
            
            // Add completed label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.pre-deployment.outputs.issue-number }},
              labels: ['completed']
            });
      
      - name: Post completion comment
        uses: actions/github-script@v7
        with:
          script: |
            const artifactName = '${{ needs.rollback-preparation.outputs.artifact-name }}';
            const checksum = '${{ needs.rollback-preparation.outputs.checksum }}';
            
            const comment = `## âœ… Deployment Completed Successfully
            
            ### Summary
            The deployment has been completed successfully. All post-deployment checks passed.
            
            ### Rollback Information
            - **Artifact Name:** ${artifactName}
            - **SHA256 Checksum:** ${checksum}
            - **Retention Period:** 30 days
            - **Access:** Available in workflow run artifacts
            
            ### Next Steps
            - Monitor application health
            - Review logs for any anomalies
            - Rollback package is available if needed
            
            ---
            ðŸŽ‰ Deployment workflow completed at $(date -u '+%Y-%m-%d %H:%M:%S UTC')`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.pre-deployment.outputs.issue-number }},
              body: comment
            });
      
      - name: Close deployment issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.pre-deployment.outputs.issue-number }},
              state: 'closed'
            });
